{"version":3,"file":"getStyleSheetForBucket.esm.js","sources":["../../../../packages/core/src/renderer/getStyleSheetForBucket.ts"],"sourcesContent":["import { DATA_BUCKET_ATTR, DATA_PRIORITY_ATTR } from '../constants';\nimport type { GriffelRenderer, IsomorphicStyleSheet, StyleBucketName } from '../types';\nimport { createIsomorphicStyleSheet } from './createIsomorphicStyleSheet';\n\n/**\n * Ordered style buckets using their short pseudo name.\n *\n * @internal\n */\nexport const styleBucketOrdering: StyleBucketName[] = [\n  // reset styles\n  'r',\n  // catch-all\n  'd',\n  // link\n  'l',\n  // visited\n  'v',\n  // focus-within\n  'w',\n  // focus\n  'f',\n  // focus-visible\n  'i',\n  // hover\n  'h',\n  // active\n  'a',\n  // at rules for reset styles\n  's',\n  // keyframes\n  'k',\n  // at-rules\n  't',\n  // @media rules\n  'm',\n  // @container rules\n  'c',\n];\n\n// avoid repeatedly calling `indexOf` to determine order during new insertions\nconst styleBucketOrderingMap = styleBucketOrdering.reduce((acc, cur, j) => {\n  acc[cur as StyleBucketName] = j;\n  return acc;\n}, {} as Record<StyleBucketName, number>);\n\nexport function getStyleSheetKey(bucketName: StyleBucketName, media: string, priority: number | string): string {\n  return (bucketName === 'm' ? bucketName + media : bucketName) + priority;\n}\n\nexport function getStyleSheetKeyFromElement(styleEl: HTMLStyleElement): string {\n  const bucketName = styleEl.getAttribute(DATA_BUCKET_ATTR) as StyleBucketName;\n  const priority = styleEl.getAttribute(DATA_PRIORITY_ATTR) ?? '0';\n\n  return getStyleSheetKey(bucketName, styleEl.media, priority);\n}\n\n/**\n * Lazily adds a `<style>` bucket to the `<head>`. This will ensure that the style buckets are ordered.\n */\nexport function getStyleSheetForBucket(\n  bucketName: StyleBucketName,\n  targetDocument: Document | undefined,\n  insertionPoint: HTMLElement | null,\n  renderer: GriffelRenderer,\n  metadata: Record<string, unknown> = {},\n): IsomorphicStyleSheet {\n  const isMediaBucket = bucketName === 'm';\n\n  const media = (metadata['m'] as string | undefined) ?? '0';\n  const priority = (metadata['p'] as number | undefined) ?? 0;\n\n  const stylesheetKey = getStyleSheetKey(bucketName, media, priority);\n\n  if (!renderer.stylesheets[stylesheetKey]) {\n    const tag: HTMLStyleElement | undefined = targetDocument && targetDocument.createElement('style');\n    const stylesheet = createIsomorphicStyleSheet(tag, bucketName, priority, {\n      ...renderer.styleElementAttributes,\n      ...(isMediaBucket && { media }),\n    });\n\n    renderer.stylesheets[stylesheetKey] = stylesheet;\n\n    if (targetDocument && tag) {\n      targetDocument.head.insertBefore(\n        tag,\n        findInsertionPoint(targetDocument, insertionPoint, bucketName, renderer, metadata),\n      );\n    }\n  }\n\n  return renderer.stylesheets[stylesheetKey]!;\n}\n\nfunction isSameInsertionKey(\n  element: HTMLStyleElement,\n  bucketName: StyleBucketName,\n  metadata: Record<string, unknown>,\n): boolean {\n  const targetKey = bucketName + ((metadata['m'] as string | undefined) ?? '');\n  const elementKey = element.getAttribute(DATA_BUCKET_ATTR) + (element.media ?? '');\n\n  return targetKey === elementKey;\n}\n\n/**\n * Finds an element before which the new bucket style element should be inserted following the bucket sort order.\n *\n * @param targetDocument - A document\n * @param insertionPoint - An element that will be used as an initial insertion point\n * @param targetBucket - The bucket that should be inserted to DOM\n * @param renderer - Griffel renderer\n * @param metadata - metadata for CSS rule\n * @returns - Smallest style element with greater sort order than the current bucket\n */\nfunction findInsertionPoint(\n  targetDocument: Document,\n  insertionPoint: HTMLElement | null,\n  targetBucket: StyleBucketName,\n  renderer: GriffelRenderer,\n  metadata: Record<string, unknown> = {},\n): Node | null {\n  const targetOrder = styleBucketOrderingMap[targetBucket];\n\n  const media = (metadata['m'] as string | undefined) ?? '';\n  const priority = (metadata['p'] as number | undefined) ?? 0;\n\n  // Similar to javascript sort comparators where\n  // a positive value is increasing sort order\n  // a negative value is decreasing sort order\n  let comparer: (el: HTMLStyleElement) => number = el =>\n    targetOrder - styleBucketOrderingMap[el.getAttribute(DATA_BUCKET_ATTR) as StyleBucketName];\n  let styleElements = targetDocument.head.querySelectorAll<HTMLStyleElement>(`[${DATA_BUCKET_ATTR}]`);\n\n  if (targetBucket === 'm') {\n    const mediaElements = targetDocument.head.querySelectorAll<HTMLStyleElement>(\n      `[${DATA_BUCKET_ATTR}=\"${targetBucket}\"]`,\n    );\n\n    // only reduce the scope of the search and change comparer\n    // if there are other media buckets already on the page\n    if (mediaElements.length) {\n      styleElements = mediaElements;\n      comparer = (el: HTMLStyleElement) => renderer.compareMediaQueries(media, el.media);\n    }\n  }\n\n  const comparerWithPriority: (el: HTMLStyleElement) => number = el => {\n    if (isSameInsertionKey(el, targetBucket, metadata)) {\n      return priority - Number(el.getAttribute('data-priority'));\n    }\n\n    return comparer(el);\n  };\n\n  const length = styleElements.length;\n  let index = length - 1;\n\n  while (index >= 0) {\n    const styleElement = styleElements.item(index);\n\n    if (comparerWithPriority(styleElement) > 0) {\n      return styleElement.nextSibling;\n    }\n\n    index--;\n  }\n\n  if (length > 0) {\n    return styleElements.item(0);\n  }\n\n  return insertionPoint ? insertionPoint.nextSibling : null;\n}\n"],"names":["styleBucketOrdering","styleBucketOrderingMap","reduce","acc","cur","j","getStyleSheetKey","bucketName","media","priority","getStyleSheetKeyFromElement","styleEl","_styleEl$getAttribute","getAttribute","DATA_BUCKET_ATTR","DATA_PRIORITY_ATTR","getStyleSheetForBucket","targetDocument","insertionPoint","renderer","metadata","_ref","_ref2","isMediaBucket","stylesheetKey","stylesheets","tag","createElement","stylesheet","createIsomorphicStyleSheet","Object","assign","styleElementAttributes","head","insertBefore","findInsertionPoint","isSameInsertionKey","element","_ref3","_element$media","targetKey","elementKey","targetBucket","_ref4","_ref5","targetOrder","comparer","el","styleElements","querySelectorAll","mediaElements","length","compareMediaQueries","comparerWithPriority","Number","index","styleElement","item","nextSibling"],"mappings":"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"}